{% extends "catalogo/base.html" %}
{% block title %}Lista de productos{% endblock %}
{% block content %}
  <h1>Lista de productos</h1>

  {% if object_list %}
    <table>
      <thead>
        <tr><th>Nombre</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr>
      </thead>
      <tbody>
        {% for p in object_list %}
          <tr>
            <td><a href="{% url 'producto_detail' p.pk %}">{{ p.nombre }}</a></td>
            <td>${{ p.precio }}</td>
            <td>{{ p.stock }}</td>
            <td>
              <a href="{% url 'producto_update' p.pk %}">Editar</a>
              <a href="{% url 'producto_delete' p.pk %}">Eliminar</a>
              <button class="btn-delete" data-id="{{ p.pk }}">Eliminar (AJAX)</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No hay productos cargados todavía.</p>
  {% endif %}

  <!-- CSRF para JS -->
  <form id="csrf-form" style="display:none">{% csrf_token %}</form>

  <script>
    function getCSRFToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    document.addEventListener('click', async (ev) => {
      if (!ev.target.matches('.btn-delete')) return;
      const id = ev.target.dataset.id;
      if (!confirm('¿Eliminar este producto?')) return;

      const resp = await fetch(`/productos/${id}/eliminar/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      const data = await resp.json().catch(() => ({}));
      if (data.ok) location.reload(); else alert('No se pudo eliminar.');
    });
  </script>
{% endblock %}

